(function(b){b.fn.pjax=function(a,c){c?c.container=a:c=b.isPlainObject(a)?a:{container:a};if(c.container&&"string"!==typeof c.container)throw"pjax container must be a string selector!";return this.live("click submit",function(a){if(1<a.which||a.metaKey)return!0;if(b(this).is("form")&&"submit"!=a.type)return!0;if(b(this).is('form[method="post"]'))return!0;var d={url:b(this).attr("href")||b(this).attr("action")||document.location.href,container:b(this).attr("data-pjax"),clickedElement:b(this),cache:!1,
fragment:null};d.ajaxurl=b(this).attr("data-ajaxurl")||d.url;if(b(this).is("form"))c.data=b(this).serialize();args=b.extend({},d,c);if(args.url.indexOf("://")&&document.location.protocol!=args.url.match(/^[a-z]+:/i))return!0;b.pjax(args);a.preventDefault()})};var d=b.pjax=function(a){var c=b(a.container),j=a.success||b.noop;delete a.success;if("string"!==typeof a.container)throw"pjax container must be a string selector!";a=b.extend(!0,{},d.defaults,a);if(b.isFunction(a.url))a.url=a.url();if(b.isFunction(a.ajaxurl))a.ajaxurl=
a.ajaxurl();a.context=c;a.success=function(c){a.cache&&b.pjax_cache(a.url,a.data,c);if(a.fragment){var f=b(c).find(a.fragment);if(f.length)c=f.children();else return window.location=a.url}else if(!b.trim(c)||/<html/i.test(c))return window.location=a.url;var g=document.title,e=b.trim(this.find("title").remove().text());!e&&a.fragment&&(e=f.attr("data-title")||f.attr("title")||f.data("title"));if(e)document.title=e;e={pjax:a.container,fragment:a.fragment,timeout:a.timeout,data:a.data,ajaxurl:a.ajaxurl,
cache:a.cache};if(a.replace)window.history.replaceState(e,document.title,a.url);else if(a.push){if(!d.active)window.history.replaceState(b.extend({},e,{url:null}),g),d.active=!0;window.history.pushState(e,document.title,a.url)}this.html(c);(a.replace||a.push)&&window._gaq&&_gaq.push(["_trackPageview"]);g=window.location.hash.toString();if(""!==g)window.location.href=g;a.clickedElement.blur();j.apply(this,arguments);b(document).trigger("pjax_complete",[c,a,f])};if((c=d.xhr)&&4>c.readyState)c.onreadystatechange=
b.noop,c.abort();d.options=a;a.cache&&(cache_data=b.pjax_cache(a.url,a.data))?(b.proxy(a.success,a.context)(cache_data),b(document).trigger("pjax_cache",[cache_data,a])):(d.xhr=b.ajax(a.ajaxurl,a),b(document).trigger("pjax",[d.xhr,a]));return d.xhr},h=[];b.pjax_cache=function(a,c,d){"string"!=typeof c&&(c=b.param(c));key=a+(/\?/.test(a)?"&":"?")+c;d&&(h[key]=d);return h[key]};d.defaults={timeout:650,push:!0,replace:!1,data:{_pjax:!0},type:"GET",dataType:"html",beforeSend:function(a){this.trigger("pjax:start",
[a,d.options]);a.setRequestHeader("X-PJAX","true")},error:function(a,b){if("abort"!==b)window.location=d.options.url},complete:function(a){this.trigger("pjax:end",[a,d.options])}};var i="state"in window.history,k=location.href;b(window).bind("popstate",function(a){var c=!i&&location.href==k;i=!0;if(!c&&(a=a.state)&&a.pjax)c=a.pjax,b(c+"").length?b.pjax({url:location.href,ajaxurl:a.ajaxurl,cache:a.cache,fragment:a.fragment,data:a.data,container:c,push:!1,timeout:a.timeout}):window.location=location.href});
0>b.inArray("state",b.event.props)&&b.event.props.push("state");b.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);if(!b.support.pjax)b.pjax=function(a){window.location=b.isFunction(a.url)?a.url():a.url},b.fn.pjax=function(){return this}})(jQuery);